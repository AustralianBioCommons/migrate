Migrate on Gadi @ the National Computational Infrastructure
================

## Accessing tool/workflow

Migrate is not centrally installed as a system module and we recommend
compiling the software as needed. This process is straightforward and is
outlined below.

In the following examples, your NCI user name is labelled as `userid`
and the project is referred to as `projectid`.

## Quickstart tutorial

### Installation of parallel version of migrate on gadi

Source code for the application is available for download from the
authorâ€™s website
\[[link](https://peterbeerli.com/migrate-html5/download_version4/)\].
The following instructions can be used to download, compile and install
version 4.4.4 of migrate on gadi. Compilation flags are set to create a
binary that will run on the broadwell, skylake and cascadelake nodes on
gadi.

    # set path for install (update the userid and projectid fields on the line below)
    install_path=/scratch/projectid/userid/apps/migrate/4.4.4
    
    # load required system modules
    module load intel-compiler/2020.2.254
    module load openmpi/4.0.2
    
    # download and unpack migrate version 4.4.4 
    wget https://peterbeerli.com/migrate-html5/download_version4/migrate-4.4.4.src.tar.gz
    tar xzf migrate-4.4.4.src.tar.gz
    
    # configure, compile and install the application
    cd migrate-4.4.4/src
    ./configure --prefix=${install_path} CC=mpicc CXX=mpic++ CFLAGS='-O3 -xCORE-AVX2 -axCORE-AVX512 -g -traceback' CXXFLAGS='-O3 -xCORE-AVX2 -axCORE-AVX512 -g -traceback'
    make mpis
    mkdir -p ${install_path}/man
    make install

During compilation, some compiler warnings and remarks may be printed.
These are normal and should not be cause for concern. After completion,
the application will be installed in the path
`/scratch/projectid/userid/apps/migrate/4.4.4`.

### Submitting a migrate job on gadi

A general guide to configuring and running migrate is given in
documentation available [here](). An example job script that can be used
to run migrate is shown below.

    #!/bin/bash
    #PBS -l walltime=48:00:00
    #PBS -l ncpus=48
    #PBS -l mem=190GB,
    #PBS -l storage=scratch/projectid
    #PBS -P projectid
    #PBS -q normal
    
    module load openmpi/4.0.2
    install_path=/scratch/projectid/userid/apps/migrate/4.4.4
    
    mpirun ${install_path}/bin/migrate-n -nomemnu ./parmfile

Where `projectid` needs to be set appropriately for the project that you
are using and the `install_path` should point to the path set in the
compilation instructions above.

This will request an allocation of 48 cores for 48 hours in the `normal`
queue. More details of the computing resources and queue system at the
NCI are available
[here](https://opus.nci.org.au/display/Help/4.+PBS+Jobs)

### Output files and results

If the model has finished properly and has not hit walltime limits there
should be at least three files in the output directory:

  - `test_migrate_run1.pdf` A pdf report file containing output from the
    program.
  - `migrate_job.o12345678` The standard output generated by the program
    during the run. The end of this file contains useful information
    resource usage during the calculation as shown in the following
    example:

<!-- end list -->

``` 
    03:33:03 Program finished
    ======================================================================================
                        Resource Usage on 2020-09-23 03:33:13:
    Job Id:                  12345678.gadi-pbs
    Project:                 projectid
    Exit Status:             0
    Service Units:           356.52
    NCPUs Requested:         48                               NCPUs Used: 48
                                                           CPU Time Used: 161:15:24
    Memory Requested:        190GB                           Memory Used: 180.06GB
    Walltime requested:      48:00:00                      Walltime Used: 06:11:37
    JobFS requested:         600.0MB                          JobFS used: 8.16MB
    ======================================================================================
```

  - `migrate_job.e12345678` The standard error generated by the programm
    during the run. This contains errors and system messages generated
    during the run.

Further files may be generated by the calculation dependent on the
parameters defined in the configuration file. For example, you may
request the bayes file be saved with a line like this:

    bayes-file=YES:test_migrate_run1.bayes

### Optimisation required

## Infrastructure usage and benchmarking

### Summary

<font size="-1.5">

| Model            | Number loci | Sample number | Replicate number | bayes-posteriorbins | burn-in | bayes-priors                                              | long-sample | Allocation (su)                  |
| ---------------- | ----------- | ------------- | ---------------- | ------------------- | ------- | --------------------------------------------------------- | ----------- | -------------------------------- |
| SAMI\_1617\_run3 | 1616        | 60            | 1                | 0                   | 50000   | MIG \* \*UNIFORMPRIOR: 100.000000 1000.000000 90.000000   | 1000000     | 1083.15                          |
| SAMI\_1617\_run4 | 1616        | 60            | 1                | 0                   | 50000   | MIG \* \*UNIFORMPRIOR: 0.000000 100000.000000 1000.000000 | 1000000     | 6709.92                          |
| SAMI\_1617\_run5 | 1616        | 60            | 1                | 1500                | 50000   | MIG \* \*UNIFORMPRIOR: 0.000000 100000.000000 1000.000000 | 1000000     | 6071.41                          |
| SAMI\_1617\_run6 | 1616        | 60            | 1                | 1500                | 50000   | MIG \* \*UNIFORMPRIOR: 100.000000 1000.000000 90.000000   | 100000      | 6069.92                          |
| SAMI\_1617\_run7 | 1616        | 60            | 1                | 1500                | 10000   | MIG \* \*UNIFORMPRIOR: 0.000000 50000.000000 10000.000000 | 100000      | \> 9216 : \> 48 hours on 192 CPU |
| Wilk\_run4       | 1093        | 24            | 2                | 1500                | 100000  | MIG \* \*UNIFORMPRIOR: 0.000000 4000.000000 400.000000    | 1000000     | 3722.56                          |
| Wilk\_run5       | 1093        | 24            | 2                | 1500                | 100000  | MIG \* \*UNIFORMPRIOR: 0.000000 10000.000000 1000.000000  | 1000000     | 3567.52                          |

</font>

### Exemplar

## Acknowledgments / citations / credits
